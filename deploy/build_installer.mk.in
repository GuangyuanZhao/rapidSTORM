PACKAGE_TARNAME:=@PACKAGE_TARNAME@
PACKAGE_VERSION:=@PACKAGE_VERSION@
ISCC:=@ISCC@
STRIP:=@STRIP@
WINE:=@WINE@
PREFIX:=@prefix@
prefix:=@prefix@
srcdir:=@srcdir@
EXTRA_INSTALLER:=@EXTRA_INSTALLER@
PATH_REWRITER:=@PATH_REWRITER@
pkgdatadir:=@datadir@/@PACKAGE@
abs_builddir:=@abs_builddir@

ME:=$(lastword $(MAKEFILE_LIST))
STAGE:=$(dir $(ME))../..
TMP:=build
BUNDLE:=$(PACKAGE_TARNAME)_$(PACKAGE_VERSION)_bin.tgz
INSTALLER:=$(PACKAGE_TARNAME)

BUNDLE_ISS_OFFSET:=installer.iss
BUNDLE_ISS:=$(TMP)/$(BUNDLE_ISS_OFFSET)

GRAPHICSMAGICK_ROOT:=/usr/local/i586-mingw32msvc
GRAPHICSMAGICK_EXPR:=-path '*/GraphicsMagick-1.3.6/config/*' -type f

prefix_binaries.lst:=$(TMP)
flags_binaries.lst:=
components_binaries.lst:=main
prefix_graphicsmagick.lst:=$(GRAPHICSMAGICK_ROOT)
flags_graphicsmagick.lst:=
components_graphicsmagick.lst:=main
prefix_java.lst:=$(PREFIX)
flags_java.lst:=
components_java.lst:=main
prefix_helpfiles.lst:=$(PREFIX)
flags_helpfiles.lst:=
components_helpfiles.lst:=main
prefix_headers.lst:=$(PREFIX)
flags_headers.lst:=
components_headers.lst:=devel
prefix_simparm_headers.lst:=$(GRAPHICSMAGICK_ROOT)
flags_simparm_headers.lst:=
components_simparm_headers.lst:=devel
prefix_libs.lst:=$(PREFIX)
flags_libs.lst:=
components_libs.lst:=devel
prefix_config_file.lst:=$(shell $(PATH_REWRITER) $(PREFIX) | sed -e 's/\\/\\\\/g')
flags_config_file.lst:=
components_config_file.lst:=main

prefix_bundle_iss.lst:=$(TMP)

all : 

$(INSTALLER).iss : dSTORM.iss
$(INSTALLER).iss : unbundle.iss config_file.iss extra_installer.iss
$(INSTALLER).iss : $(srcdir)/dSTORM_tail.iss

ifneq ($(WINE),)
BUNDLE_LISTS:=binaries.lst config_file.lst helpfiles.lst graphicsmagick.lst headers.lst simparm_headers.lst libs.lst java.lst
bundle : $(BUNDLE)
include auto.dep
include graphicsmagick.dep

$(BUNDLE) : bundle_iss.lst $(BUNDLE_LISTS)
	tar cfz $@ $(foreach list,bundle_iss.lst $(BUNDLE_LISTS),-C $(prefix_$(list)) --files-from=$(list) -C $(abs_builddir))

unbundle.iss : $(BUNDLE_ISS)
	sed -e 's#:prefix:[/\\]##' $< > $@

else
unbundle.iss : $(pkgdatadir)/bundle.iss
	sed -e 's#:prefix:/#$(shell $(PATH_REWRITER) $(PREFIX) | sed -e 's/\\/\\\\/g')#' $< > $@

bundle :
	false
endif

ifneq ($(ISCC),)
installer : $(INSTALLER).exe
$(INSTALLER).exe : $(INSTALLER).iss Readme.txt License.txt inst.bmp
	'$(ISCC)' '$<'
else
installer : $(INSTALLER).tgz

$(INSTALLER).tgz : $(BUNDLE_LISTS)
	tar cfz $@ -C $(TMP) --files-from=rel_file_list.lst \
	           -C $(PREFIX) --files-from=prefix_file_list.lst

prefix_file_list.lst : rapid2storm.iss
	sed -n -e 's#.*Source: "$(PREFIX)[/\\]\([^"]*\)".*#\1#p' $< > $@
rel_file_list.lst : rapid2storm.iss
	sed -n -e 's#.*Source: "\([^\\/][^"]*\)".*#\1#p' $< > $@
endif

.DELETE_ON_ERROR :

Readme.txt : $(srcdir)/../README
License.txt : $(srcdir)/../LICENSE
inst.bmp : $(srcdir)/inst.bmp

bundle_iss.lst : $(BUNDLE_ISS)
	$(PATH_REWRITER) $(BUNDLE_ISS_OFFSET) > $@

$(BUNDLE_ISS) : dSTORM.iss $(BUNDLE_LISTS:.lst=.iss) $(srcdir)/dSTORM_tail.iss
	mkdir -p $(dir $@)
	{ cat dSTORM.iss; cat $(BUNDLE_LISTS:.lst=.iss) | sed -e 's#Source: "[^"]*\(/[^/"]*\)"; DestDir: "\({.*}/\)\([^"]*\)"#Source: "\3\1"; DestDir: "\2\3"#'; cat $(srcdir)/dSTORM_tail.iss; } > $@

extra_installer.iss : $(EXTRA_INSTALLER)
	sed -e 's#Source: "#&$(shell $(PATH_REWRITER) $(dir $<) | sed -e 's/\\/\\\\/g')#' $(if $<,$<,/dev/null) > $@

config_file.lst :
	f=share/$(PACKAGE_TARNAME)/dstorm-config.txt; test -e $(PREFIX)/$$f && $(PATH_REWRITER) $$f > $@
java.lst : $(PREFIX)/share/java/rapidSTORM.jar
	test -e $< && echo share/java/rapidSTORM.jar > $@

graphicsmagick.dep : 
	if test 'x$(GRAPHICSMAGICK_ROOT)' = 'x'; then echo > $@; else \
	find $(GRAPHICSMAGICK_ROOT) $(GRAPHICSMAGICK_EXPR)\
	    -printf 'graphicsmagick : $(STAGE)/%P\n$(STAGE)/%P : %p\n' \
	    > $@; fi

binaries.lst : loaded_DLLs.txt binaries
	sed -e 's§tag \(.*\) \(.*\)§\2§' $< > $@

binaries :
	touch $@

helpfiles.lst : storm.out
	cat $< | tr '\r\t' '  ' | sed -n -e 's§^help_file set \([^ ]*\) *§share/doc/\1§p' > $@

graphicsmagick.lst : 
	find $(GRAPHICSMAGICK_ROOT) $(GRAPHICSMAGICK_EXPR) -printf '%P\n' > $@

libs.lst :
	find $(PREFIX)/lib -name 'libdStorm*' | sed -e 's§^$(PREFIX)/§§'  > $@

headers.lst :
	find $(PREFIX)/include/dStorm -type f | sed -e 's§^$(PREFIX)/§§'  > $@

simparm_headers.lst :
	find $(GRAPHICSMAGICK_ROOT)/include/simparm -type f | sed -e 's§^$(GRAPHICSMAGICK_ROOT)/§§'  > $@

%.exe :
	mkdir -p $(dir $@)
	$(STRIP) -o $@ $<
%.dll :
	mkdir -p $(dir $@)
	if test $(notdir $<) != "ATMCD32D.dll"; then $(STRIP) -o $@ $<; else cp $< $@; fi
%.txt : 
	cp $< $@
%.bmp : 
	cp $< $@

$(INSTALLER).iss :
	cat $^ > $@

%.iss : %.lst
	{ \
	  echo "[Files]"; \
	  sed -e 's§\(.*\)\([/\\]\)\([^/\\]*\)§Source: "$(prefix_$<)\2\1\2\3"; DestDir: "{app}\2\1"; Components: $(components_$<)$(if $(flags_$<),; Flags: $(flags_$<),)§' $<; \
	} > $@

storm.out :
	{ echo "attach"; echo "quit"; } |\
	  WINEDEBUG="loaddll" wine $(PREFIX)/bin/dstorm.exe --Twiddler \
	  > $@ 2>&1

loaded_DLLs.txt : storm.out
	sed -n -e 's§.*Loaded L"Z:\(.*\)" at [0-9a-fA-Fx]*: native.*§\1§p' $< | \
	sed -e 's/\\\\/\//g' | \
	sed -e 's§\(^/.*\)/bin/\([^/]*\)$$§tag \1 bin/\2§' \
	    -e 's§^$(PREFIX)/§tag $(PREFIX) §' > $@
	test `grep -v -c '^tag '  $@` = 0

auto.dep : loaded_DLLs.txt 
	sed -e 's/^tag \(.*\) \(.*\)/storm.out : \1\/\2/' $< > $@
	sed -e 's§^tag \(.*\) \(.*\)§binaries : $(TMP)/\2§' $< >> $@
	sed -e 's§^tag \(.*\) \(.*\)§$(TMP)/\2 : \1/\2§' $< >> $@
